name: ðŸš€ Deploy to Azure
run-name: ðŸš€ Deploy to Azure (${{ inputs.environment || (github.event_name == 'pull_request' && github.base_ref == 'main' && 'ci preview prod') || (github.event_name == 'pull_request' && github.base_ref == 'staging' && 'ci preview staging') || (github.event_name == 'push' && github.ref == 'refs/heads/main' && 'prod') || (github.event_name == 'push' && github.ref == 'refs/heads/staging' && 'staging') || 'dev' }} - ${{ inputs.action || (github.event_name == 'pull_request' && 'provision') || 'up' }})

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      action:
        description: 'Action to perform'
        required: true
        default: 'up'
        type: choice
        options:
          - provision  # Infrastructure only
          - deploy     # Application only
          - up         # Both infrastructure and application
          - down       # Destroy everything

  push:
    branches:
      - main
      - staging
    paths:
      - 'infra/terraform/**'
      - 'src/**'
      - 'apps/**'
      - 'azure.yaml'
      - '.github/workflows/_template-deploy-azd.yml'

  pull_request:
    branches:
      - main
      - staging
    paths:
      - 'infra/terraform/**'
      - 'azure.yaml'
      - '.github/workflows/_template-deploy-azd.yml'

jobs:
  # ============================================================================
  # DEPLOY - Calls the reusable template workflow
  # ============================================================================
  deploy:
    name: ðŸš€ Deploy
    uses: ./.github/workflows/_template-deploy-azd.yml
    with:
      # For workflow_dispatch: use input
      # For push to main: deploy to prod
      # For push to staging: deploy to staging
      # For pull_request: use target branch to determine environment (staging for staging, dev for main)
      environment: ${{ inputs.environment || (github.event_name == 'push' && github.ref == 'refs/heads/main' && 'prod') || (github.event_name == 'push' && github.ref == 'refs/heads/staging' && 'staging') || (github.event_name == 'pull_request' && github.base_ref == 'main' && 'prod') || (github.event_name == 'pull_request' && github.base_ref == 'staging' && 'staging') || 'dev' }}
      action: ${{ inputs.action || (github.event_name == 'pull_request' && 'provision') || 'up' }}
    secrets: inherit
