name: _template-deploy-azd
# This is a reusable workflow template - do not run directly.
# Use "Deploy to Azure" workflow instead.

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: string
      action:
        description: 'Action to perform'
        required: true
        default: 'up'
        type: string
      rs_resource_group:
        description: 'Resource group for Terraform state storage'
        required: false
        type: string
      rs_storage_account:
        description: 'Storage account for Terraform state'
        required: false
        type: string
      rs_container_name:
        description: 'Container name for Terraform state'
        required: false
        type: string
      db_initialized:
        description: 'Database initialization status'
        required: false
        type: string
    secrets:
      GH_PAT:
        description: 'Optional GitHub PAT used to write environment variables (GITHUB_TOKEN cannot)'
        required: false
    outputs:
      resource_group:
        description: 'The resource group name'
        value: ${{ jobs.execute.outputs.resource_group }}
      frontend_url:
        description: 'The frontend application URL'
        value: ${{ jobs.execute.outputs.frontend_url }}
      backend_url:
        description: 'The backend application URL'
        value: ${{ jobs.execute.outputs.backend_url }}
      container_registry_endpoint:
        description: 'The container registry endpoint'
        value: ${{ jobs.execute.outputs.container_registry_endpoint }}
      appconfig_endpoint:
        description: 'The Azure App Configuration endpoint'
        value: ${{ jobs.execute.outputs.appconfig_endpoint }}
      appconfig_label:
        description: 'The Azure App Configuration label'
        value: ${{ jobs.execute.outputs.appconfig_label }}
      # Evaluation-related outputs
      openai_endpoint:
        description: 'Azure OpenAI endpoint for evaluations'
        value: ${{ jobs.execute.outputs.openai_endpoint }}
      openai_deployment:
        description: 'Azure OpenAI chat deployment ID'
        value: ${{ jobs.execute.outputs.openai_deployment }}
      speech_region:
        description: 'Azure Speech region for evaluations'
        value: ${{ jobs.execute.outputs.speech_region }}
      ai_foundry_project_endpoint:
        description: 'AI Foundry project endpoint for evaluation traces'
        value: ${{ jobs.execute.outputs.ai_foundry_project_endpoint }}

env:
  AZD_SKIP_INTERACTIVE: true
  CI: true

permissions:
  contents: read
  id-token: write
  pull-requests: write  # Required for PR comments with preview results

# ==============================================================================
# JOBS
# ==============================================================================
jobs:

  # ============================================================================
  # JOB: SETUP - Authentication & Configuration
  # ============================================================================
  setup:
    name: ğŸ” Setup
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    outputs:
      auth_success: ${{ steps.auth-check.outputs.success }}
      use_oidc: ${{ steps.detect-auth.outputs.use_oidc }}
      azure_env_name: ${{ inputs.environment }}
      # Pass through existing environment variables if set
      appconfig_endpoint_existing: ${{ vars.AZURE_APPCONFIG_ENDPOINT }}
      appconfig_label_existing: ${{ vars.AZURE_APPCONFIG_LABEL }}
      container_registry_endpoint_existing: ${{ vars.AZURE_CONTAINER_REGISTRY_ENDPOINT }}
      resource_group_existing: ${{ vars.AZURE_RESOURCE_GROUP }}
    
    env:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
    
    steps:
      - name: ğŸ” Detect Authentication Method
        id: detect-auth
        run: |
          if [ -z "${{ env.AZURE_CLIENT_SECRET }}" ]; then
            echo "use_oidc=true" >> $GITHUB_OUTPUT
            echo "ğŸ“Œ Using OIDC authentication"
          else
            echo "use_oidc=false" >> $GITHUB_OUTPUT
            echo "ğŸ“Œ Using Service Principal authentication"
          fi

      - name: ğŸ” Azure Login (OIDC)
        if: steps.detect-auth.outputs.use_oidc == 'true'
        uses: azure/login@v2
        id: azure-login-oidc
        continue-on-error: true
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: ğŸ” Azure Login (Service Principal)
        if: steps.detect-auth.outputs.use_oidc == 'false'
        uses: azure/login@v2
        id: azure-login-sp
        with:
          creds: '{"clientId":"${{ env.AZURE_CLIENT_ID }}","clientSecret":"${{ env.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ env.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ env.AZURE_TENANT_ID }}"}'

      - name: âœ… Verify Authentication
        id: auth-check
        run: |
          OIDC_SUCCESS="${{ steps.azure-login-oidc.outcome }}"
          SP_SUCCESS="${{ steps.azure-login-sp.outcome }}"
          
          if [ "$OIDC_SUCCESS" = "success" ] || [ "$SP_SUCCESS" = "success" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Authentication successful"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ Authentication failed"
          fi

  # ============================================================================
  # JOB: PREVIEW - For Pull Requests
  # ============================================================================
  preview:
    name: ğŸ“‹ Preview Changes
    runs-on: ubuntu-latest
    needs: setup
    if: github.event_name == 'pull_request' && needs.setup.outputs.auth_success == 'true'
    environment: ${{ inputs.environment }}
    
    env:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      USE_OIDC: ${{ needs.setup.outputs.use_oidc }}
      AZURE_ENV_NAME: ${{ inputs.environment }}
      RS_RESOURCE_GROUP: ${{ inputs.rs_resource_group || vars.rs_resource_group }}
      RS_STORAGE_ACCOUNT: ${{ inputs.rs_storage_account || vars.rs_storage_account }}
      RS_CONTAINER_NAME: ${{ inputs.rs_container_name || vars.rs_container_name }}
    
    steps:
      - name: ğŸ›’ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}
        if: env.USE_OIDC == 'true'

      - name: ğŸ” Azure Login (SP)
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ env.AZURE_CLIENT_ID }}","clientSecret":"${{ env.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ env.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ env.AZURE_TENANT_ID }}"}'
        if: env.USE_OIDC == 'false'

      - name: âš™ï¸ Setup Tools
        uses: Azure/setup-azd@v2
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: ğŸ” AZD Login
        run: |
          if [ "${{ env.USE_OIDC }}" = "true" ]; then
            azd auth login --client-id "$AZURE_CLIENT_ID" --federated-credential-provider github --tenant-id "$AZURE_TENANT_ID"
          else
            azd auth login --client-id "$AZURE_CLIENT_ID" --client-secret "$AZURE_CLIENT_SECRET" --tenant-id "$AZURE_TENANT_ID"
          fi

      - name: âš™ï¸ Configure Environment
        run: |
          # Create/select environment
          azd env list --output json | jq -e ".[] | select(.name==\"$AZURE_ENV_NAME\")" > /dev/null 2>&1 || \
            azd env new "$AZURE_ENV_NAME" --no-prompt
          azd env select "$AZURE_ENV_NAME"
          
          # Set remote state config
          azd env set RS_RESOURCE_GROUP "$RS_RESOURCE_GROUP"
          azd env set RS_STORAGE_ACCOUNT "$RS_STORAGE_ACCOUNT"
          azd env set RS_CONTAINER_NAME "$RS_CONTAINER_NAME"
          azd env set RS_STATE_KEY "${AZURE_ENV_NAME}.tfstate"
          
          # Set location from tfvars
          TFVARS_FILE="infra/terraform/params/main.tfvars.${AZURE_ENV_NAME}.json"
          [ -f "$TFVARS_FILE" ] && azd env set AZURE_LOCATION "$(jq -r '.location // "eastus2"' "$TFVARS_FILE")"

      - name: ğŸª Run Preprovision Hook
        run: |
          echo "ğŸ”§ Running azd hooks run preprovision..."
          azd hooks run preprovision

      - name: ğŸ“‹ Run Preview
        id: preview
        run: |
          echo "ğŸ” Running azd provision --preview..."
          if azd provision --no-prompt --preview > preview-output.txt 2>&1; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi
          cat preview-output.txt
        env:
          ARM_CLIENT_ID: ${{ env.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ env.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ env.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: ${{ env.USE_OIDC }}
          ARM_CLIENT_SECRET: ${{ env.USE_OIDC == 'false' && env.AZURE_CLIENT_SECRET || '' }}

      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            let preview = 'No preview output available.';
            try { preview = fs.readFileSync('preview-output.txt', 'utf8'); } catch {}
            if (preview.length > 60000) preview = preview.slice(0, 60000) + '\n...[truncated]';
            
            const success = '${{ steps.preview.outputs.success }}' === 'true';
            const body = `## ğŸ—ï¸ Infrastructure Preview ${success ? 'âœ…' : 'âš ï¸'}
            
            **Environment:** \`${{ inputs.environment }}\`

            <details>
            <summary>Preview Output</summary>

            \`\`\`
            ${preview}
            \`\`\`
            </details>`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: ğŸ“‹ Job Summary
        run: |
          echo "## ğŸ“‹ Preview Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.preview.outputs.success == 'true' && 'âœ… Success' || 'âš ï¸ Check logs' }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # JOB: EXECUTE - Run AZD Commands (provision/deploy/up/down)
  # ============================================================================
  execute:
    name: ${{ inputs.action == 'provision' && 'ğŸ—ï¸ Provision' || inputs.action == 'deploy' && 'ğŸ“¦ Deploy' || inputs.action == 'up' && 'ğŸš€ Up' || 'ğŸ’¥ Down' }}
    runs-on: ubuntu-latest
    needs: setup
    if: github.event_name != 'pull_request' && needs.setup.outputs.auth_success == 'true'
    environment: ${{ inputs.environment }}
    
    outputs:
      resource_group: ${{ steps.outputs.outputs.resource_group }}
      frontend_url: ${{ steps.outputs.outputs.frontend_url }}
      backend_url: ${{ steps.outputs.outputs.backend_url }}
      container_registry_endpoint: ${{ steps.outputs.outputs.container_registry_endpoint }}
      appconfig_endpoint: ${{ steps.outputs.outputs.appconfig_endpoint }}
      appconfig_label: ${{ steps.outputs.outputs.appconfig_label }}
      # Evaluation-related outputs
      openai_endpoint: ${{ steps.outputs.outputs.openai_endpoint }}
      openai_deployment: ${{ steps.outputs.outputs.openai_deployment }}
      speech_region: ${{ steps.outputs.outputs.speech_region }}
      ai_foundry_project_endpoint: ${{ steps.outputs.outputs.ai_foundry_project_endpoint }}
    
    env:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      USE_OIDC: ${{ needs.setup.outputs.use_oidc }}
      AZURE_ENV_NAME: ${{ inputs.environment }}
      RS_RESOURCE_GROUP: ${{ inputs.rs_resource_group || vars.rs_resource_group }}
      RS_STORAGE_ACCOUNT: ${{ inputs.rs_storage_account || vars.rs_storage_account }}
      RS_CONTAINER_NAME: ${{ inputs.rs_container_name || vars.rs_container_name }}
      DB_INITIALIZED: ${{ inputs.db_initialized || vars.db_initialized }}
      # Use existing App Config from environment variables if available
      EXISTING_APPCONFIG_ENDPOINT: ${{ needs.setup.outputs.appconfig_endpoint_existing }}
      EXISTING_APPCONFIG_LABEL: ${{ needs.setup.outputs.appconfig_label_existing }}
      # Use existing Container Registry endpoint from environment variables if available
      EXISTING_CONTAINER_REGISTRY_ENDPOINT: ${{ needs.setup.outputs.container_registry_endpoint_existing }}
      # Use existing resource group from environment variables if available (deploy-only runs)
      EXISTING_AZURE_RESOURCE_GROUP: ${{ needs.setup.outputs.resource_group_existing }}
    
    steps:
      - name: ğŸ›’ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}
        if: env.USE_OIDC == 'true'

      - name: ğŸ” Azure Login (SP)
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ env.AZURE_CLIENT_ID }}","clientSecret":"${{ env.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ env.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ env.AZURE_TENANT_ID }}"}'
        if: env.USE_OIDC == 'false'

      - name: âš™ï¸ Setup Tools
        uses: Azure/setup-azd@v2

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: ğŸ” AZD Login
        run: |
          if [ "${{ env.USE_OIDC }}" = "true" ]; then
            azd auth login --client-id "$AZURE_CLIENT_ID" --federated-credential-provider github --tenant-id "$AZURE_TENANT_ID"
          else
            azd auth login --client-id "$AZURE_CLIENT_ID" --client-secret "$AZURE_CLIENT_SECRET" --tenant-id "$AZURE_TENANT_ID"
          fi

      - name: âš™ï¸ Configure Environment
        run: |
          # Create/select environment
          azd env list --output json | jq -e ".[] | select(.name==\"$AZURE_ENV_NAME\")" > /dev/null 2>&1 || \
            azd env new "$AZURE_ENV_NAME" --no-prompt
          azd env select "$AZURE_ENV_NAME"
          
          # Set remote state config
          azd env set RS_RESOURCE_GROUP "$RS_RESOURCE_GROUP"
          azd env set RS_STORAGE_ACCOUNT "$RS_STORAGE_ACCOUNT"
          azd env set RS_CONTAINER_NAME "$RS_CONTAINER_NAME"
          azd env set DB_INITIALIZED "${DB_INITIALIZED:-true}"
          
          # Set location from tfvars
          TFVARS_FILE="infra/terraform/params/main.tfvars.${AZURE_ENV_NAME}.json"
          [ -f "$TFVARS_FILE" ] && azd env set AZURE_LOCATION "$(jq -r '.location // "eastus2"' "$TFVARS_FILE")"
          
          # Use existing App Config endpoint from GitHub environment if available
          if [ -n "$EXISTING_APPCONFIG_ENDPOINT" ]; then
            echo "ğŸ“Œ Using existing AZURE_APPCONFIG_ENDPOINT from environment: $EXISTING_APPCONFIG_ENDPOINT"
            azd env set AZURE_APPCONFIG_ENDPOINT "$EXISTING_APPCONFIG_ENDPOINT"
          fi
          if [ -n "$EXISTING_APPCONFIG_LABEL" ]; then
            echo "ğŸ“Œ Using existing AZURE_APPCONFIG_LABEL from environment: $EXISTING_APPCONFIG_LABEL"
            azd env set AZURE_APPCONFIG_LABEL "$EXISTING_APPCONFIG_LABEL"
          fi

          # Use existing Container Registry endpoint from GitHub environment if available
          if [ -n "$EXISTING_CONTAINER_REGISTRY_ENDPOINT" ]; then
            echo "ğŸ“Œ Using existing AZURE_CONTAINER_REGISTRY_ENDPOINT from environment: $EXISTING_CONTAINER_REGISTRY_ENDPOINT"
            azd env set AZURE_CONTAINER_REGISTRY_ENDPOINT "$EXISTING_CONTAINER_REGISTRY_ENDPOINT"
          fi

          # Use existing resource group from GitHub environment if available
          if [ -n "$EXISTING_AZURE_RESOURCE_GROUP" ]; then
            echo "ğŸ“Œ Using existing AZURE_RESOURCE_GROUP from environment: $EXISTING_AZURE_RESOURCE_GROUP"
            azd env set AZURE_RESOURCE_GROUP "$EXISTING_AZURE_RESOURCE_GROUP"
            echo "AZURE_RESOURCE_GROUP=$EXISTING_AZURE_RESOURCE_GROUP" >> "$GITHUB_ENV"
          fi

      - name: ğŸ”§ Setup Terraform Parameters
        run: |
          TFVARS_FILE="infra/terraform/params/main.tfvars.${AZURE_ENV_NAME}.json"
          if [ -f "$TFVARS_FILE" ]; then
            echo "ğŸ“„ Loading params from: $TFVARS_FILE"
            for key in $(jq -r 'keys[]' "$TFVARS_FILE"); do
              value_type=$(jq -r --arg k "$key" '.[$k] | type' "$TFVARS_FILE")
              [ "$value_type" = "null" ] && continue
              if [ "$value_type" = "string" ]; then
                value=$(jq -r --arg k "$key" '.[$k]' "$TFVARS_FILE")
              else
                value=$(jq -c --arg k "$key" '.[$k]' "$TFVARS_FILE")
              fi
              echo "TF_VAR_${key}=${value}" >> $GITHUB_ENV
            done
          fi
          
          echo "TF_VAR_environment_name=$AZURE_ENV_NAME" >> $GITHUB_ENV
          echo "TF_VAR_principal_type=ServicePrincipal" >> $GITHUB_ENV
          echo "TF_VAR_deployed_by=$GITHUB_ACTOR" >> $GITHUB_ENV

      - name: ğŸ”§ Configure Backend
        run: |
          cat > infra/terraform/backend.tf << EOF
          terraform {
            backend "azurerm" {
              resource_group_name  = "$RS_RESOURCE_GROUP"
              storage_account_name = "$RS_STORAGE_ACCOUNT"
              container_name       = "$RS_CONTAINER_NAME"
              key                  = "${AZURE_ENV_NAME}.tfstate"
              use_azuread_auth     = true
            }
          }
          EOF

      - name: ğŸ“¥ Load AZD Environment Values
        if: inputs.action != 'down'
        run: |
          # Pull any previously saved values (including AZURE_RESOURCE_GROUP) from the azd environment
          if azd env get-values > /tmp/azd-values.env 2>/dev/null; then
            set -a
            # shellcheck disable=SC1091
            source /tmp/azd-values.env
            set +a

            if [ -n "${AZURE_RESOURCE_GROUP:-}" ]; then
              echo "AZURE_RESOURCE_GROUP=$AZURE_RESOURCE_GROUP" >> "$GITHUB_ENV"
              echo "ğŸ“Œ Using AZURE_RESOURCE_GROUP=$AZURE_RESOURCE_GROUP"
            else
              echo "â„¹ï¸ AZURE_RESOURCE_GROUP not present in azd env (may be set during provision)."
            fi

            if [ -n "${AZURE_CONTAINER_REGISTRY_ENDPOINT:-}" ]; then
              echo "AZURE_CONTAINER_REGISTRY_ENDPOINT=$AZURE_CONTAINER_REGISTRY_ENDPOINT" >> "$GITHUB_ENV"
              echo "ğŸ“Œ Using AZURE_CONTAINER_REGISTRY_ENDPOINT=$AZURE_CONTAINER_REGISTRY_ENDPOINT"
            fi
          else
            echo "â„¹ï¸ azd env get-values failed (environment may not be initialized yet)."
          fi

      - name: âœ… Require AZURE_RESOURCE_GROUP for deploy
        if: inputs.action == 'deploy'
        run: |
          if [ -z "${AZURE_RESOURCE_GROUP:-}" ]; then
            echo "âŒ AZURE_RESOURCE_GROUP is not set for this environment."
            echo "   Run 'up' or 'provision' first, or set AZURE_RESOURCE_GROUP explicitly."
            exit 1
          fi

      # ----------------------------------------------------------------------
      # ACTION: PROVISION
      # ----------------------------------------------------------------------
      - name: ğŸ—ï¸ azd provision
        if: inputs.action == 'provision'
        run: |
          echo "ğŸ—ï¸ Provisioning infrastructure..."
          azd provision --no-prompt
        env:
          ARM_CLIENT_ID: ${{ env.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ env.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ env.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: ${{ env.USE_OIDC }}
          ARM_CLIENT_SECRET: ${{ env.USE_OIDC == 'false' && env.AZURE_CLIENT_SECRET || '' }}

      # ----------------------------------------------------------------------
      # ACTION: DEPLOY
      # ----------------------------------------------------------------------
      - name: ğŸ“¦ azd deploy
        if: inputs.action == 'deploy'
        run: |
          echo "ğŸ“¦ Deploying application..."
          azd deploy --no-prompt
        env:
          ARM_CLIENT_ID: ${{ env.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ env.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ env.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: ${{ env.USE_OIDC }}
          ARM_CLIENT_SECRET: ${{ env.USE_OIDC == 'false' && env.AZURE_CLIENT_SECRET || '' }}

      # ----------------------------------------------------------------------
      # ACTION: UP (provision + deploy)
      # ----------------------------------------------------------------------
      - name: ğŸš€ azd up
        if: inputs.action == 'up'
        run: |
          echo "ğŸš€ Provisioning and deploying..."
          azd up --no-prompt
        env:
          ARM_CLIENT_ID: ${{ env.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ env.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ env.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: ${{ env.USE_OIDC }}
          ARM_CLIENT_SECRET: ${{ env.USE_OIDC == 'false' && env.AZURE_CLIENT_SECRET || '' }}

      # ----------------------------------------------------------------------
      # ACTION: DOWN
      # ----------------------------------------------------------------------
      - name: ğŸ’¥ azd down
        if: inputs.action == 'down'
        run: |
          echo "Running preprovision hook to ensure environment variables..."
          azd hooks run preprovision || echo "âš ï¸ Preprovision hook failed or not found, continuing..."
          
          echo "Destroying resources..."
          azd down --force --purge --no-prompt
        env:
          ARM_CLIENT_ID: ${{ env.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ env.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ env.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: ${{ env.USE_OIDC }}
          ARM_CLIENT_SECRET: ${{ env.USE_OIDC == 'false' && env.AZURE_CLIENT_SECRET || '' }}

      # ----------------------------------------------------------------------
      # EXTRACT OUTPUTS
      # ----------------------------------------------------------------------
      - name: ğŸ“¤ Extract Outputs
        id: outputs
        if: inputs.action == 'up' || inputs.action == 'provision'
        run: |
          echo "ğŸ” Extracting deployment outputs..."
          
          if azd env get-values > /tmp/azd-values.env 2>/dev/null; then
            source /tmp/azd-values.env
            
            echo "resource_group=${AZURE_RESOURCE_GROUP:-unknown}" >> $GITHUB_OUTPUT
            echo "container_registry_endpoint=${AZURE_CONTAINER_REGISTRY_ENDPOINT:-}" >> $GITHUB_OUTPUT
            
            # Use full URLs (with https://) if available, otherwise construct from FQDN
            if [ -n "${FRONTEND_CONTAINER_APP_URL:-}" ]; then
              echo "frontend_url=${FRONTEND_CONTAINER_APP_URL}" >> $GITHUB_OUTPUT
            elif [ -n "${FRONTEND_CONTAINER_APP_FQDN:-}" ]; then
              echo "frontend_url=https://${FRONTEND_CONTAINER_APP_FQDN}" >> $GITHUB_OUTPUT
            else
              echo "frontend_url=" >> $GITHUB_OUTPUT
            fi
            
            if [ -n "${BACKEND_CONTAINER_APP_URL:-}" ]; then
              echo "backend_url=${BACKEND_CONTAINER_APP_URL}" >> $GITHUB_OUTPUT
            elif [ -n "${BACKEND_CONTAINER_APP_FQDN:-}" ]; then
              echo "backend_url=https://${BACKEND_CONTAINER_APP_FQDN}" >> $GITHUB_OUTPUT
            else
              echo "backend_url=" >> $GITHUB_OUTPUT
            fi
            
            echo "appconfig_endpoint=${AZURE_APPCONFIG_ENDPOINT:-}" >> $GITHUB_OUTPUT
            echo "appconfig_label=${AZURE_APPCONFIG_LABEL:-${{ inputs.environment }}}" >> $GITHUB_OUTPUT
            
            # Evaluation-related outputs
            echo "openai_endpoint=${AZURE_OPENAI_ENDPOINT:-}" >> $GITHUB_OUTPUT
            echo "openai_deployment=${AZURE_OPENAI_CHAT_DEPLOYMENT_ID:-gpt-4o}" >> $GITHUB_OUTPUT
            echo "speech_region=${AZURE_SPEECH_REGION:-}" >> $GITHUB_OUTPUT
            echo "ai_foundry_project_endpoint=${ai_foundry_account_endpoint:-}" >> $GITHUB_OUTPUT
            
            echo "ğŸ“Š Outputs extracted:"
            echo "  Resource Group: ${AZURE_RESOURCE_GROUP:-unknown}"
            echo "  Frontend URL: ${FRONTEND_CONTAINER_APP_URL:-https://${FRONTEND_CONTAINER_APP_FQDN:-not set}}"
            echo "  Backend URL: ${BACKEND_CONTAINER_APP_URL:-https://${BACKEND_CONTAINER_APP_FQDN:-not set}}"
            echo "  App Config: ${AZURE_APPCONFIG_ENDPOINT:-not set}"
            echo "  OpenAI Endpoint: ${AZURE_OPENAI_ENDPOINT:-not set}"
            echo "  Speech Region: ${AZURE_SPEECH_REGION:-not set}"
            echo "  AI Foundry: ${ai_foundry_account_endpoint:-not set}"
          else
            echo "âš ï¸ Could not extract outputs"
            echo "resource_group=unknown" >> $GITHUB_OUTPUT
          fi

      - name: ğŸšª Logout
        if: always()
        run: az logout || true

  # ============================================================================
  # JOB: FINALIZE - Set Environment Variables & Summary
  # ============================================================================
  finalize:
    name: ğŸ“‹ Finalize
    runs-on: ubuntu-latest
    needs: [setup, execute]
    if: always() && github.event_name != 'pull_request' && needs.execute.result == 'success'
    environment: ${{ inputs.environment }}
    
    steps:
      - name: ğŸ“ Update GitHub Environment Variables
        if: inputs.action != 'down'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          APPCONFIG_ENDPOINT: ${{ needs.execute.outputs.appconfig_endpoint }}
          APPCONFIG_LABEL: ${{ needs.execute.outputs.appconfig_label }}
          CONTAINER_REGISTRY_ENDPOINT: ${{ needs.execute.outputs.container_registry_endpoint }}
          RESOURCE_GROUP: ${{ needs.execute.outputs.resource_group }}
          # Evaluation-related outputs
          OPENAI_ENDPOINT: ${{ needs.execute.outputs.openai_endpoint }}
          OPENAI_DEPLOYMENT: ${{ needs.execute.outputs.openai_deployment }}
          SPEECH_REGION: ${{ needs.execute.outputs.speech_region }}
          AI_FOUNDRY_PROJECT_ENDPOINT: ${{ needs.execute.outputs.ai_foundry_project_endpoint }}
        run: |
          echo "ğŸ“ Updating GitHub environment variables for '${{ inputs.environment }}'..."

          if [ -z "${GH_TOKEN:-}" ]; then
            echo "â„¹ï¸ GH_PAT not provided; skipping environment variable persistence."
            exit 0
          fi
          
          if [ -n "$APPCONFIG_ENDPOINT" ] && [ "$APPCONFIG_ENDPOINT" != "unknown" ]; then
            gh variable set AZURE_APPCONFIG_ENDPOINT \
              --body "$APPCONFIG_ENDPOINT" \
              --env "${{ inputs.environment }}" \
              --repo "${{ github.repository }}" || echo "âš ï¸ Could not set AZURE_APPCONFIG_ENDPOINT"
            echo "âœ… AZURE_APPCONFIG_ENDPOINT=$APPCONFIG_ENDPOINT"
          fi
          
          if [ -n "$APPCONFIG_LABEL" ] && [ "$APPCONFIG_LABEL" != "unknown" ]; then
            gh variable set AZURE_APPCONFIG_LABEL \
              --body "$APPCONFIG_LABEL" \
              --env "${{ inputs.environment }}" \
              --repo "${{ github.repository }}" || echo "âš ï¸ Could not set AZURE_APPCONFIG_LABEL"
            echo "âœ… AZURE_APPCONFIG_LABEL=$APPCONFIG_LABEL"
          fi

          if [ -n "$CONTAINER_REGISTRY_ENDPOINT" ] && [ "$CONTAINER_REGISTRY_ENDPOINT" != "unknown" ]; then
            gh variable set AZURE_CONTAINER_REGISTRY_ENDPOINT \
              --body "$CONTAINER_REGISTRY_ENDPOINT" \
              --env "${{ inputs.environment }}" \
              --repo "${{ github.repository }}" || echo "âš ï¸ Could not set AZURE_CONTAINER_REGISTRY_ENDPOINT"
            echo "âœ… AZURE_CONTAINER_REGISTRY_ENDPOINT=$CONTAINER_REGISTRY_ENDPOINT"
          fi

          if [ -n "$RESOURCE_GROUP" ] && [ "$RESOURCE_GROUP" != "unknown" ]; then
            gh variable set AZURE_RESOURCE_GROUP \
              --body "$RESOURCE_GROUP" \
              --env "${{ inputs.environment }}" \
              --repo "${{ github.repository }}" || echo "âš ï¸ Could not set AZURE_RESOURCE_GROUP"
            echo "âœ… AZURE_RESOURCE_GROUP=$RESOURCE_GROUP"
          fi
          
          # Evaluation-related variables
          if [ -n "$OPENAI_ENDPOINT" ] && [ "$OPENAI_ENDPOINT" != "unknown" ]; then
            gh variable set AZURE_OPENAI_ENDPOINT \
              --body "$OPENAI_ENDPOINT" \
              --env "${{ inputs.environment }}" \
              --repo "${{ github.repository }}" || echo "âš ï¸ Could not set AZURE_OPENAI_ENDPOINT"
            echo "âœ… AZURE_OPENAI_ENDPOINT=$OPENAI_ENDPOINT"
          fi
          
          if [ -n "$OPENAI_DEPLOYMENT" ] && [ "$OPENAI_DEPLOYMENT" != "unknown" ]; then
            gh variable set AZURE_OPENAI_CHAT_DEPLOYMENT_ID \
              --body "$OPENAI_DEPLOYMENT" \
              --env "${{ inputs.environment }}" \
              --repo "${{ github.repository }}" || echo "âš ï¸ Could not set AZURE_OPENAI_CHAT_DEPLOYMENT_ID"
            echo "âœ… AZURE_OPENAI_CHAT_DEPLOYMENT_ID=$OPENAI_DEPLOYMENT"
          fi
          
          if [ -n "$SPEECH_REGION" ] && [ "$SPEECH_REGION" != "unknown" ]; then
            gh variable set AZURE_SPEECH_REGION \
              --body "$SPEECH_REGION" \
              --env "${{ inputs.environment }}" \
              --repo "${{ github.repository }}" || echo "âš ï¸ Could not set AZURE_SPEECH_REGION"
            echo "âœ… AZURE_SPEECH_REGION=$SPEECH_REGION"
          fi
          
          if [ -n "$AI_FOUNDRY_PROJECT_ENDPOINT" ] && [ "$AI_FOUNDRY_PROJECT_ENDPOINT" != "unknown" ]; then
            gh variable set AZURE_AI_FOUNDRY_PROJECT_ENDPOINT \
              --body "$AI_FOUNDRY_PROJECT_ENDPOINT" \
              --env "${{ inputs.environment }}" \
              --repo "${{ github.repository }}" || echo "âš ï¸ Could not set AZURE_AI_FOUNDRY_PROJECT_ENDPOINT"
            echo "âœ… AZURE_AI_FOUNDRY_PROJECT_ENDPOINT=$AI_FOUNDRY_PROJECT_ENDPOINT"
          fi

      - name: ğŸ“‹ Generate Summary
        run: |
          ACTION="${{ inputs.action }}"
          ENV="${{ inputs.environment }}"
          
          if [ "$ACTION" = "down" ]; then
            echo "## ğŸ’¥ Resources Destroyed" >> $GITHUB_STEP_SUMMARY
            echo "Environment \`$ENV\` has been destroyed." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ğŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Environment | \`$ENV\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Action | \`$ACTION\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Resource Group | \`${{ needs.execute.outputs.resource_group }}\` |" >> $GITHUB_STEP_SUMMARY
            
            FRONTEND="${{ needs.execute.outputs.frontend_url }}"
            BACKEND="${{ needs.execute.outputs.backend_url }}"
            APPCONFIG="${{ needs.execute.outputs.appconfig_endpoint }}"
            APPCONFIG_LABEL="${{ needs.execute.outputs.appconfig_label }}"
            OPENAI_ENDPOINT="${{ needs.execute.outputs.openai_endpoint }}"
            SPEECH_REGION="${{ needs.execute.outputs.speech_region }}"
            AI_FOUNDRY="${{ needs.execute.outputs.ai_foundry_project_endpoint }}"
            
            [ -n "$FRONTEND" ] && echo "| Frontend | [$FRONTEND]($FRONTEND) |" >> $GITHUB_STEP_SUMMARY
            [ -n "$BACKEND" ] && echo "| Backend | [$BACKEND]($BACKEND) |" >> $GITHUB_STEP_SUMMARY
            
            if [ -n "$APPCONFIG" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### âš™ï¸ App Configuration" >> $GITHUB_STEP_SUMMARY
              echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
              echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Endpoint | \`$APPCONFIG\` |" >> $GITHUB_STEP_SUMMARY
              echo "| Label | \`$APPCONFIG_LABEL\` |" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Evaluation-related outputs
            if [ -n "$OPENAI_ENDPOINT" ] || [ -n "$AI_FOUNDRY" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ğŸ§ª Evaluation Configuration" >> $GITHUB_STEP_SUMMARY
              echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
              echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
              [ -n "$OPENAI_ENDPOINT" ] && echo "| OpenAI Endpoint | \`$OPENAI_ENDPOINT\` |" >> $GITHUB_STEP_SUMMARY
              [ -n "$SPEECH_REGION" ] && echo "| Speech Region | \`$SPEECH_REGION\` |" >> $GITHUB_STEP_SUMMARY
              [ -n "$AI_FOUNDRY" ] && echo "| AI Foundry | \`$AI_FOUNDRY\` |" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> These values have been saved to the GitHub environment \`$ENV\`" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # JOB: PREVIEW NO AUTH - Limited preview when auth fails
  # ============================================================================
  preview-no-auth:
    name: ğŸ“‹ Preview (Limited)
    runs-on: ubuntu-latest
    needs: setup
    if: github.event_name == 'pull_request' && needs.setup.outputs.auth_success != 'true'
    
    steps:
      - name: âš ï¸ Authentication Required
        run: |
          echo "## âš ï¸ Limited Preview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Full infrastructure preview requires Azure authentication." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configure Authentication" >> $GITHUB_STEP_SUMMARY
          echo "**Option 1 - OIDC (Recommended):**" >> $GITHUB_STEP_SUMMARY
          echo "- Configure federated identity in Azure AD" >> $GITHUB_STEP_SUMMARY
          echo "- Set secrets: \`AZURE_CLIENT_ID\`, \`AZURE_TENANT_ID\`, \`AZURE_SUBSCRIPTION_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Option 2 - Service Principal:**" >> $GITHUB_STEP_SUMMARY
          echo "- Set secrets: \`AZURE_CLIENT_ID\`, \`AZURE_CLIENT_SECRET\`, \`AZURE_TENANT_ID\`, \`AZURE_SUBSCRIPTION_ID\`" >> $GITHUB_STEP_SUMMARY
